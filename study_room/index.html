<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <title>study room</title>
        <style>
            .leveltime{
                height: 10em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 25%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
            .time{
                height: 6em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 10%;
                left: 85%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
                background-color: rgb(240, 240, 240);
            }
            .music{
                width: 36em;
                height: 20em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 58%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
            .memo{
                height: 10em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 75%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
            .time_elapsed_level{
                height: 10em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 30%;
                left: 23.5%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
            .time_elapsed_level progress{
                width: 500%;
            }
            .time_elapsed_level h1{
                color: red;
                width: 10cm;
                height: 4cm;
                position: relative;
                margin: 0;
                position: absolute;
                top: 80%;
                left: 190%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
            .explain{
                position: absolute;
                justify-content: center;
                top: 115%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
                width: 90vw;   /* ç”»é¢ã®å¹…ã®90% */
                height: 50vh;  /* ç”»é¢ã®é«˜ã•ã®50% */
                max-height: 600px;
            }
            .test{
                height: 10em;
                position: relative;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 50%;
                margin-right: -50%;
                transform: translate(-50%, -50%);
            }
        </style>
        <link rel="shortcut icon" href="../png/funny_games_icon.png">
        <script src="./sql/sql-wasm.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    </head>
    <body onload="setData_count_up();setData_memo();setData_time_elapsed_level();initializeApp();drawChartFromSQL();">
        <!--ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼-->
        <div class="leveltime">
            <input type="button" id="start" value=" ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚¹ãƒˆãƒƒãƒ— " onclick="timer_start()">
            <input type="button" id="reset" value=" ãƒªã‚»ãƒƒãƒˆã™ã‚‹ " onclick="reset_timer()">
            <br>
            <p>level (Max: <span id="max_level_text"></span>) ã‚¯ãƒªãƒƒã‚¯ã§æ¨ç§»</p><input type="button" id="level" value="" onclick="drawChartFromSQL()">
            <p>EXP</p><input type="button" id="exp" value="">
            <p>study time</p><input type="button" id="time" value="">
            <p>daily time</p><input type="button" id="dailytime" value="">
            <br>
            <br>
        </div>
        <iframe class="music" src="https://funny-games.github.io/study_room/music/"></iframe>
        <!--ãƒ¡ãƒ¢-->
        <div class="memo">
            <textarea cols="40" rows="7" id="textarea_up"></textarea>
            <br>
            <textarea cols="40" rows="7" id="textarea_down"></textarea>
            <br>
            <button onclick="save_memo_data()">ãƒ¡ãƒ¢ã‚’ä¿å­˜ã™ã‚‹</button>
            <button onclick="reset_memo()">ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã™ã‚‹</button>
        </div>
        <!--æ™‚é–“-->
        <div class="time">
            <h1 id="text"></h1>
        </div>
        <!--æ™‚é–“çµŒéã§é€²ã‚€-->
        <div class="time_elapsed_level">
            <progress id="progress" value="0" max="100">
            </progress>
            <br>
            <p>ç›®æ¨™ã®ãƒ¬ãƒ™ãƒ«ã‚’å…¥åŠ›:</p>
            <input type="text" id="goal_level" value="0">
            <button id="set_level" onclick="level_set()">è¨­å®šã™ã‚‹</button>
            <h1 id="goal_label"></h1>
            <br>
        </div>
        <div class="explain">
            <canvas id="levelChart" width="600" height="300" style="justify-content: center;"></canvas>
            <script>
                let chartInstance = null;

                function drawChartFromSQL() {
                    if (!window.db) {
                        console.log("DBæœªåˆæœŸåŒ–ï¼");
                        return;
                    }

                    const res = window.db.exec(`
                        SELECT date, MAX(level) as level
                        FROM log
                        GROUP BY date
                        ORDER BY date ASC;
                    `);

                    if (res.length === 0) {
                        console.log("ğŸ“­ ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ãªã„ã‚ˆï¼");
                        return;
                    }

                    if (chartInstance) {
                        chartInstance.destroy();
                    }

                    const dates = res[0].values.map(row => row[0]);
                    const levels = res[0].values.map(row => row[1]);

                    const ctx = document.getElementById("levelChart").getContext("2d");

                    chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'ğŸ“ˆ ãƒ¬ãƒ™ãƒ«ã®æ¨ç§»ï¼ˆMAX/æ—¥ï¼‰',
                                data: levels,
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 2,
                                fill: false,
                                tension: 0.2,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Level'
                                    }
                                },
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        displayFormats: {
                                            day: 'MM/DD'
                                        }
                                    }
                                }
                            }
                        }
                    });
                }     
            </script>
        </div>
        <script>
            let SQL, db;

            async function initializeApp() {
                // SQL.jsã®åˆæœŸåŒ–
                SQL = await initSqlJs({
                    locateFile: file => "./sql/" + file
                });

                const request = indexedDB.open("MyStudyDB", 1);

                request.onupgradeneeded = function(event) {
                    const dbStorage = event.target.result;
                    // âœ… ã‚¹ãƒˆã‚¢ãŒãªã‘ã‚Œã°ã“ã“ã§ä½œã‚‹ï¼
                    if (!dbStorage.objectStoreNames.contains("databases")) {
                        dbStorage.createObjectStore("databases");
                        console.log("ğŸ†• ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã‚’ä½œæˆã—ãŸã‚ˆï¼");
                    }
                };

                request.onsuccess = function(event) {
                    const dbStorage = event.target.result;
                    const transaction = dbStorage.transaction("databases", "readonly");
                    const store = transaction.objectStore("databases");

                    const getRequest = store.get("main");
                    getRequest.onsuccess = function() {
                        if (getRequest.result) {
                            db = new SQL.Database(getRequest.result);
                            console.log("ğŸ“‚ IndexedDBã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã ã‚ˆï¼");
                        } else {
                            db = new SQL.Database();
                            console.log("ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ãŒãªã‹ã£ãŸã®ã§æ–°è¦ä½œæˆï¼");
                        }
                        window.db = db;  // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«
                        console.log("âœ… DBåˆæœŸåŒ–å®Œäº†ã—ã¦ window.db ã«è¨­å®šã—ãŸã‚ˆï¼");
                    };
                };

                request.onerror = function() {
                    console.error("âŒ IndexedDBã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼");
                    db = new SQL.Database();
                    window.db = db;  // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«
                };

                console.log("âœ… DBåˆæœŸåŒ–æˆåŠŸï¼");
            }
        </script>
        <script src="./js/count_up.js"></script>
        <script src="./js/memo.js"></script>
        <script src="./js/time.js"></script>
        <script src="./js/time_elapsed_level.js"></script>
    </body>
    <footer>
        <p>ver. 0.6</p>
    </footer>
</html>